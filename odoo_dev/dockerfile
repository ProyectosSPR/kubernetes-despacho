# Usa la imagen oficial de Odoo 17
FROM odoo:17

# ==== Parte 1: Instalación de dependencias del sistema y Git ====
USER root
# Se actualizan los repositorios y se instala git, además de las dependencias para Jupyter
# Se añade --no-install-recommends para reducir el tamaño de la imagen
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    python3-pip \
    python3-dev \
    build-essential \
    # Se limpia el caché de apt para mantener la imagen ligera
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# ==== Parte 2: Clonar el repositorio de addons extra ====
# Se clona directamente desde GitHub en la carpeta de addons
# Usamos --depth 1 para clonar solo la última versión, haciendo el proceso más rápido y ligero
RUN git clone --depth 1 https://github.com/ProyectosSPR/modulos_odoo.git /mnt/extra-addons

# ==== Parte 3: Instalar librerías de Python (Jupyter) ====
RUN pip3 install --no-cache-dir --upgrade pip \
    && pip3 install --no-cache-dir jupyterlab ipython ipykernel pandas requests odoorpc

# ==== Parte 4: Configurar entorno de Jupyter y permisos ====
# Se crea el directorio para los notebooks
RUN mkdir -p /opt/jupyter
# Se asigna la propiedad de ambas carpetas al usuario 'odoo' en un solo paso
RUN chown -R odoo:odoo /mnt/extra-addons /opt/jupyter

# Script de arranque automático del entorno Odoo en Jupyter (sin cambios)
RUN echo "\
import odoo\n\
import builtins\n\
odoo.cli.server.report_configuration = lambda _: None\n\
odoo.tools.config.parse_config(['-c', '/etc/odoo/odoo.conf'])\n\
from odoo.api import Environment\n\
from odoo import SUPERUSER_ID\n\
import psycopg2\n\
db_name = odoo.tools.config['db_name']\n\
if not db_name:\n\
    print('⚠️ No hay base de datos configurada. Conéctate manualmente.')\n\
else:\n\
    registry = odoo.registry(db_name)\n\
    cr = odoo.sql_db.db_connect(db_name).cursor()\n\
    env = Environment(cr, SUPERUSER_ID, {})\n\
    builtins.env = env\n\
    builtins.cr = cr\n\
    print(f'✅ Entorno Odoo listo en env (BD: {db_name})')\n\
" > /opt/jupyter/odoo_shell_init.py

# Celda automática para notebooks nuevos (sin cambios)
RUN mkdir -p /opt/jupyter/.ipython/profile_default/startup
RUN echo "exec(open('/opt/jupyter/odoo_shell_init.py').read())" \
    > /opt/jupyter/.ipython/profile_default/startup/00-odoo-shell.py

# Asegurar que IPython use el perfil creado (sin cambios)
ENV IPYTHONDIR=/opt/jupyter/.ipython

# ==== Parte 5: Exponer puertos ====
EXPOSE 8069 8888

# ==== Parte 6: Arranque combinado Odoo + Jupyter ====
USER odoo
# El comando de arranque se mantiene igual
CMD ["bash", "-c", "odoo -c /etc/odoo/odoo.conf & jupyter lab --ip=0.0.0.0 --port=8888 --ServerApp.token=admin --notebook-dir=/opt/jupyter --no-browser"]