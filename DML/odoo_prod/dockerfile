# ------------------------------------------------------------------
# Dockerfile para Odoo 16 con Jupyter Lab Integrado
# ------------------------------------------------------------------

# Usa la imagen oficial de Odoo 16
FROM odoo:16

# ===============================================
# Parte 1: Definir variables de entorno
# ===============================================
ENV JUPYTER_HOME=/opt/jupyter
ENV ODOO_EXTRA_ADDONS=/mnt/extra-addons

# ===============================================
# Parte 2: Modificación de usuario, dependencias, clonado y permisos
# ===============================================
USER root

# Modificamos el usuario 'odoo' para asegurar que tenga un home y un shell
RUN usermod -d /var/lib/odoo -s /bin/bash odoo

# Copiamos el archivo de dependencias ANTES de instalar para aprovechar el cache
COPY requirements.txt .

# Se agrupan m�ltiples comandos en una sola capa (RUN) para optimizar la imagen
RUN apt-get update && apt-get install -y --no-install-recommends \
        git \
        python3-pip \
        # --- Dependencias para compilar python-ldap ---
        build-essential \
        python3-dev \
        libldap2-dev \
        libsasl2-dev \
        # --- Herramientas de diagn�stico ---
        net-tools \
        procps \
        dnsutils \
        curl \
        iputils-ping \
        nano \
    && apt-get clean && rm -rf /var/lib/apt/lists/* \
    # 1. Actualizamos pip
    && python3 -m pip install --upgrade pip \
    # 2. Instalamos los requerimientos.
    #    Usamos --no-cache-dir para ahorrar espacio
    #    Usamos --break-system-packages (requerido en Debian 12+)
    #    Esto SOBREESCRIBIR� las versiones del 'odoo:16' base
    #    con las versiones exactas de nuestro requirements.txt
    && pip install --no-cache-dir --ignore-installed --break-system-packages -r requirements.txt \
    # 3. Clonamos los m�dulos (�Aseg�rate que este repo sea para Odoo 16!)
    && git clone --depth 1 https://github.com/ProyectosSPR/modulos_odoo.git ${ODOO_EXTRA_ADDONS} \
    # 4. Creamos y damos permisos a las carpetas
    && mkdir -p ${JUPYTER_HOME} \
    && chown -R odoo:root ${ODOO_EXTRA_ADDONS} ${JUPYTER_HOME}

# ===============================================
# Parte 3: Configurar entorno de Jupyter
# ===============================================
# (Esta parte estaba perfecta, no se toca)

# Script de inicialización para cargar el entorno de Odoo en Jupyter
RUN cat <<'EOF' > ${JUPYTER_HOME}/odoo_shell_init.py
import odoo
import builtins
import configparser
import logging

_logger = logging.getLogger(__name__)

config = configparser.ConfigParser()
config.read('/etc/odoo/odoo.conf')
db_name = config.get('options', 'db_name', fallback=None)

builtins.env = None
builtins.cr = None

if not db_name:
    print('❌ No se encontró db_name en /etc/odoo/odoo.conf. No se pudo inicializar el entorno de Odoo.')
else:
    try:
        registry = odoo.modules.registry.Registry.new(db_name)
        cr = registry.cursor()
        env = odoo.api.Environment(cr, odoo.SUPERUSER_ID, {})
        
        builtins.env = env
        builtins.cr = cr
        
        print(f'✅ Entorno Odoo listo. Usa la variable global `env` (BD: {db_name})')

    except Exception as e:
        _logger.error("Error al inicializar el entorno de Odoo: %s", e)
        print(f"❌ Error al inicializar el entorno de Odoo: {e}")
        if 'cr' in locals() and cr:
            cr.close()
EOF

# Celda automática para notebooks nuevos
RUN mkdir -p ${JUPYTER_HOME}/.ipython/profile_default/startup
RUN echo "exec(open('${JUPYTER_HOME}/odoo_shell_init.py').read())" \
    > ${JUPYTER_HOME}/.ipython/profile_default/startup/00-odoo-shell.py

# Asegurar que IPython use el perfil creado y los permisos sean correctos
ENV IPYTHONDIR=${JUPYTER_HOME}/.ipython
RUN chown -R odoo:root ${JUPYTER_HOME}

# ===============================================
# Parte 4: Exponer puertos y configurar arranque
# ===============================================
EXPOSE 8069 8888 8072

USER odoo
WORKDIR /var/lib/odoo

# Comando de arranque para iniciar Odoo y Jupyter Lab
# Se usa --notebook-dir para que inicie en el home de odoo
# Se añade --ServerApp.token='admin' para un token fácil de recordar
CMD ["bash", "-c", "odoo -c /etc/odoo/odoo.conf & jupyter lab --ip=0.0.0.0 --port=8888 --ServerApp.token=admin --notebook-dir=/var/lib/odoo --no-browser"]